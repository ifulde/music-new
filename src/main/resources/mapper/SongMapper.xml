<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.musicai.mapper.SongMapper">
    <resultMap id="SongResultMap" type="Song">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="artist" column="artist"/>
        <result property="album" column="album"/>
        <result property="duration" column="duration"/>
        <result property="filePath" column="file_path"/>
        <result property="coverPath" column="cover_path"/>
        <result property="playCount" column="play_count"/>
        <result property="uploaderId" column="uploader_id"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO songs (title, artist, album, duration, file_path, cover_path, play_count, uploader_id, created_at)
        VALUES (#{title}, #{artist}, #{album}, #{duration}, #{filePath}, #{coverPath}, #{playCount}, #{uploaderId}, #{createdAt})
    </insert>

    <select id="findById" resultMap="SongResultMap">
        SELECT * FROM songs WHERE id = #{id}
    </select>

    <select id="findAll" resultMap="SongResultMap">
        SELECT * FROM songs
        <where>
            <if test="search != null and search != ''">
                AND (title LIKE CONCAT('%', #{search}, '%')
                OR artist LIKE CONCAT('%', #{search}, '%')
                OR album LIKE CONCAT('%', #{search}, '%'))
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="count" resultType="long">
        SELECT COUNT(*) FROM songs
        <where>
            <if test="search != null and search != ''">
                AND (title LIKE CONCAT('%', #{search}, '%')
                OR artist LIKE CONCAT('%', #{search}, '%')
                OR album LIKE CONCAT('%', #{search}, '%'))
            </if>
        </where>
    </select>

    <update id="update">
        UPDATE songs
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="artist != null">artist = #{artist},</if>
            <if test="album != null">album = #{album},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM songs WHERE id = #{id}
    </delete>

    <update id="incrementPlayCount">
        UPDATE songs SET play_count = play_count + 1 WHERE id = #{id}
    </update>
</mapper>

